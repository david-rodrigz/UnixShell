#!/bin/bash

# set the program name
prg=./try

# declare an array of test names
declare -a test_names=(
    "Test_pwd"
    "Test_sleep"
    "Test_IO_redirection"
    "Test_pipeline"
    "Test_background"
)

# declare a function for each test

# pwd test
run_Test_pwd() {
    # set input value
    echo "pwd" >$1/inp

    # set expected value
    pwd >$1/exp
    
    # input from the inp file and output to the out file
    $prg <$1/inp 2>&1 >$1/out
}

# sleep test
run_Test_sleep() {
    # set input value
    echo "sleep 5 ; exit" >$1/inp

    # set expected value
    echo "" >$1/exp

    # capture the start time
    start_time=$(date +%s)

    # input from the inp file and output to the out file
    $prg <$1/inp 2>&1 >$1/out

    # capture the end time
    end_time=$(date +%s)

    # calculate the difference in seconds
    seconds_passed=$((end_time - start_time))

    # extract sleep time from inp file
    sec=$(grep -oP '(?<=sleep )\d+' $1/inp | cut -f1 -d' ')

    # compare seconds_passed with the expected value
    # if not equal, redirect error message to out file
    if [ $seconds_passed -ne $sec ]; then
        echo "$1 failed: Expected $sec seconds, but got $seconds_passed seconds" 2>&1 >>$1/out
    else
        echo "" >$1/exp
    fi
}

# IO redirection test
run_Test_IO_redirection() {
    # set input value
    echo "echo "Hello World!" > hello.txt ; cat < hello.txt > hello2.txt ; cat < hello2.txt" >$1/inp

    # set expected value
    echo "Hello World!" >$1/exp

    # input from the inp file and output to the out file
    $prg <$1/inp 2>&1 >$1/out

    # remove hello.txt and hello2.txt if they exist
    rm -f hello.txt hello2.txt
}

# pipelines test
run_Test_pipeline() {
    # set input value
    echo "pwd | cat ; cd /etc | pwd" >$1/inp

    # set expected value
    (pwd | cat ; cd /etc | pwd) >$1/exp

    # input from the inp file and output to the out file
    $prg <$1/inp 2>&1 >$1/out

}

# background test
run_Test_background() {
    # set input value
    echo "echo \"sleep 5 ; echo this message second\" > ${1}/delayed_msg.sh" >$1/inp
    echo "source ${1}/delayed_msg.sh &" >>$1/inp
    echo "echo this message first" >>$1/inp
    echo "wait" >>$1/inp

    # set expected value
    echo "this message first" >$1/exp
    echo "this message second" >>$1/exp

    # input from the inp file and output to the out file
    $prg <$1/inp 2>&1 >$1/out

    # remove delayed_msg.sh if it exists
    rm -f $1/delayed_msg.sh
}

# run each test
for t in ${test_names[@]}; do
    # make directory for the test if it doesn't exist
    mkdir -p Test/$t

    # echo the test name
    echo $t

    # run the test
    run_${t} "Test/$t"

    # compare the output with the expected output
    if diff -q -w Test/$t/exp Test/$t/out 2>&1 >/dev/null; then
        echo "PASSED"
    else
        echo "FAILED" >&2
    fi
    echo ""
done